# 5.4 인터넷 서비스 제공업자(ISP)간의 라우팅: BGP

<br>

## 경계 게이트웨이 프로토콜(BGP)
- 패킷이 여러 AS를 지날 때 수행하는 AS간 라우팅 프로토콜
- BGP는 패킷이 CIDR 형식으로 표현된 주소의 프리픽스를 향해 전달

<br>

## BGP 역할
 - 이웃 AS를 통해 도달 가능한 서브넷 프리픽스 정보 제공
 - 서브넷 주소 프리픽스의 가장 좋은 경로 결정

<br>

## BGP 경로 정보 알리기
- 과정
  1) 프리픽스 x가 포함된 AS의 게이트웨이 라우터가 인접 AS 게이트 라우터에 eBGP 연결로 정보 알림
  2) 정보를 받은 게이트 라우터는 자신의 AS 내 라우터들에게 iBFP 연결로 정보 알림
  3) 다시 게이트 라우터는 다른 인접 AS 게이트 라우터에 eBGP 연결로 정보를 알리며 반복
  4) AS-PATH 내 현재 리스트에 지나오는 AS를 저장하면서 메시지를 전달, 중복 경로는 버림

- 용어
  * `게이트웨이 라우터` : AS의 경계에 있는 라우터로 다른 AS의 라우터와 연결
  * `내부 라우터` : 자신의 AS 내의 라우터와만 연결
  * `BGP 연결` : 포트번호 179의 TCP연결을 통해 라우팅 정보를 BGP 메시지를 통해 교환하는 연결
  * `외부 BGP(eBGP)` : 2개의 AS 간 BGP 연결
  * `내부 BGP(iBGP)` : 같은 AS 내 라우터 간 BGP 연결, 물리적 링크와는 다름

<br>

## 최고의 경로 결정
- 우선순위
  1) 최고 지역 선호도 경로 결정
  2) 최단 AS-PATH 경로 결정
  3) 최단 NEXT-HOP 경로 결정(뜨거운 감자 라우팅)
  4) BGP 식별자 활용 경로 결정
- 결정된 경로는 포워딩 테이블에 (서브넷 주소, 인터페이스)를 추가

- 용어
  * `지역 선호도` : AS 네트워크 관리자에 의해 결정한 정책
  * `AS-PATH` : 목적지에 가기 위해 지나야 하는 AS 목록, AS홉 수를 사용
  * `NEXT-HOP` : AS-PATH가 시작되는 라우터 인터페이스 IP 주소
  * `뜨거운 감자 라우팅` : 가장 적은 비용의 게이트웨이 라우터 선택

<br>

<p align="center"><img width="650" alt="링크 추가" src="https://user-images.githubusercontent.com/86337233/213658063-f56d6a18-67ac-40c4-9ed4-c0e025822fc5.png">

1b에서 x를 목적지로 전송되고 각 라우터 간 이동 비용은 동일(1)하다고 가정할 때
 - 최단 AS-PATH 기준에 따르면 AS2 - AS3보다 바로 AS3으로 가는 경우가 AS홉 수가 적으므로 3d인터페이스로 경로 결정
 - 뜨거운 감자 라우팅에 따르면 1b에서 2a인터페이스로 이동 비용은 2, 3d인터페이스로 이동 비용은 3이므로 2a인터페이스로 경로 결정
 - 최단 AS-PATH 경로가 뜨거운 감자 라우팅 경로보다 우선되므로 3d인터페이스로 경로 결정

<br>

## IP 애니캐스트
- 여러 서버가 동일 IP 주소를 사용하여 네트워크 트래픽을 사용 가능 서버 중 가장 가까운 곳으로 라우팅
- 최단 거리를 찾을 때 BGP를 활용 ex) DNS

<br>

## 라우팅 정책
<p align="center"><img width="640" alt="BGP 정책" src="https://user-images.githubusercontent.com/86337233/213658073-8398ac03-a290-49be-8260-696b19d42110.png">
  
 - 사용자 네트워크는 자신에게 들어오고 나가는 모든 트래픽의 목적지 또는 출발지여야 하는데 
   W가 Y로 갈 때 W-A-B-X-C-Y로 가게 되면 이에 위배되므로 라우팅 정책을 통해 XCY 경로를 막을 수 있음
 - Y에서 W로 갈 때 Y-C-B-A-W 경로는 불필요하게 B를 거쳐가게 되므로 라우팅 정책을 통해 Y-C-A-W의 경로를 선택하도록 할 수 있음
