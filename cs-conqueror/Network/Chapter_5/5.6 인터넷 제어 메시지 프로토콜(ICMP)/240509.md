# 5.6 인터넷 제어 메시지 프로토콜(ICMP)

`인터넷 제어 메시지 프로토콜(Internet Control Message Protocol, ICMP)`은 호스트와 라우터가 서로 간에 네트워크 계층 정보를 주고받기 위해 사용

- ICMP는 종종 IP의 한 부분으로 간주되지만, ICMP 메시지가 IP 데이터그램에 담겨 전송되므로 **구조적으로는 IP 바로 위에 있음**
- 즉, ICMP 메시지도 **IP 페이로드로 전송되며,** 호스트가 상위 계층 프로토콜이 ICMP라고 표시된(상위 계층 프로토콜 번호가 1번인) IP 데이터그램을 받으면 ICMP로 내용을 역다중화함

<br/>

ICMP 메시지는 `타입(type)과 코드(code) 필드`가 있고,  
ICMP 메시지의 발생 원인이 된 IP 데이터그램의 헤더와 첫 8바이트를 가짐

<br/>

<p align="center"><img width="400" alt="ICMP 메시지 타입" src="https://user-images.githubusercontent.com/86337233/213726337-f62a70cd-a7c6-4384-91e5-c692228d6fa0.png">

<br/>

### ping 프로그램

1. `타입 8, 코드 0인 ICMP 메시지`를 특정 호스트에 보냄
2. 목적지 호스트는 에코 요청을 보고 나서 `타입 0, 코드 0인 ICMP 에코 응답`을 보냄

대부분의 TCP/IP 구현은 ping 서버를 운영체제에서 직접 지원
(즉, ping 서버는 별도의 프로세스가 아님)

<br/>

### Traceroute 프로그램

출발지 호스트는 자신과 목적지 호스트 사이에 있는 라우터 수, 정체, 그리고 두 호스트 간의 왕복 시간을 알게 됨

<br/>

1. **출발지와 목적지 사이의 라우터 이름과 주소를 알아내기 위해**  
   출발지의 Traceroute는 일련의 `IP 데이터그램`을 목적지에 보냄
    - 각각의 데이터그램은 UDP 포트 번호를 가진 **UDP 세그먼트**를 운반
    - TTL 값은 첫 번째 데이터그램이 1, 두 번째는 2, 세 번째는 3 ...

2. 출발지는 각 데이터그램에 대해 타이머를 작동
    - n번째 데이터그램이 n번째 라우터에 도착하면 해당 라우터는 데이터그램의 TTL이 방금 만료되었음을 알아챔

3. IP 프로토콜 규칙에 따라 라우터는 데이터그램을 폐기하고 `ICMP 경고 메시지(타입 11, 코드 0)`를 출발지에 보냄
    - 이 경고 메시지는 라우터의 이름과 IP 주소를 포함

4. 이 ICMP 메시지가 출발지에 도착하면, 출발지는  
   (1) 타이머로부터 왕복 시간(round-trip time, RTT),  
   (2) ICMP 메시지로부터 n번째 라우터의 주소와 이름을 획득

<br/>

*Traceroute 출발지는 UDP 세그먼트 전송을 언제 멈춰야 하는지 어떻게 알까?*

1. 출발지가 자신이 보내는 각 데이터그램마다 차례로 TTL을 1씩 증가시키기 때문에  
   이들 데이터그램 중 하나는 결국 목적지 호스트에 도착하게 됨

2. 이 데이터그램은 없을 것 같은 UDP 포트 번호를 가진 UDP 세그먼트를 포함하고 있으므로,  
   목적지 호스트는 `포트 도달 불가능 ICMP 메시지(타입 3, 코드 3)`를 출발지에 보냄

3. 출발지 호스트가 이 ICMP 메시지를 받게 되면 추가적인 탐색 패킷을 보낼 필요가 없음을 알게 됨
