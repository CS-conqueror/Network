# 인터넷 프로토콜

<br>

## 1. IPv4

---

### 1) 데이터그램 포맷
#### (1) 헤더
 - `버전 번호` : IP 프로토콜 버전, IPv4는 4
 - `헤더 길이` : 헤더 기본 길이(20바이트) + 옵션 길이, 헤더 길이 이후부터 페이로드임을 알 수 있음
 - `서비스 타입` : IP 데이터그램의 유형을 구별(실시간, 우선순위, 음성 등)
 - `데이터그램 길이` : 헤더 길이 + 데이터 길이
 - `식별자` : 분할된 IP 데이터그램이 같은 데이터그램인지 확인
 - `플래그` : 데이터그램의 분할 여부
 - `단편화 오프셋` : 분할되기 전 원래 데이터그램의 시작지점
 - `TTL(time-to-live)` : 라우터가 데이터그램을 처리할 때마다 감소하고 0이 되면 폐기
 - `상위계층 프로토콜` : IP 데이터그램의 데이터가 전달될 목적지의 트랜스포트 계층의 프로토콜, TCP는 6 / UDP는 17
 - `헤더 체크섬` : 데이터그램을 송신할 때마다 헤더 체크섬을 계산하여 필드에 저장하고 데이터그램이 수신될 때 헤더 체크섬을 계산하여 저장된 헤더 체크섬과 비교하여 오류가 있는지 확인
 -  `출발지 IP 주소와 목적지 IP 주소` : 출발지와 목적지의 IP 주소로 32비트를 차지
 -  `옵션` : 추가적인 헤더 정보
#### (2) 데이터(페이로드) : 전송하고자하는 데이터

<br>

### 2) 주소체계
#### (1) 관련 용어
 - `인터페이스` : 라우터, 호스트와 물리적 링크 사이의 경계
 - `서브넷` : 라우터 없이 인터페이스가 중계하는 고립된 네트워크

<br>

#### (2) 주소체계
 - IP주소는 32비트 길이로 점으로 구분하는 십진 표기법 사용
   ex) 223.1.1.0
 - `서브넷 마스크` : /x와 같은 형태로 사용하며 왼쪽부터 x개의 비트가 서브넷 주소라는 것을 알리고 나머지 주소로 호스트를 구분
   ex) 223.1.1.0/24 -> 왼쪽부터 24비트가 서브넷 주소로 서브넷 주소가 같은 호스트들은 같은 서브넷에 존재하고 나버지 8비트로 호스트를 구분
- `255.255.255.255` : 같은 서브넷에 있는 모든 호스트에게 전달하는 IP주소

<br>

#### (3) 주소 할당 방식
 - `클래스 주소체계` : 서브넷 주소 길이를 8(A), 16(B), 24(C)인 클래스 네트워크로 분류, 적절한 주소를 할당시키기기 어려워 비효율적
 - `CIDR(Classless InterDomain Routing)` : 서브넷 주소 길이를 프리픽스로 지정해서 사용 가능, 네트워크의 크기에 알맞게 주소를 할당할 수 있으며 추가 서브넷 구조를 만들기에도 용이
 - 주소 블록 할당 : 주소 블록을 제공하는 ISP 혹은 ICANN을 통해서 주소를 할당 받음
 - `동적 호스트 구성 프로토콜(DHCP)` : 개별 IP 주소를 수동으로 구성하지 않고 DHCP 서버를 통하여 자동으로 구성
    ##### (a) DHCP 프로토콜 4단계
    * DHCP 서버 발견 : 새롭게 도착한 호스트는 DHCP 발견 메시지(목적지 IP주소 : 255.255.255.255, 출발지 IP주소 : 0.0.0.0 등)를 사용하여 포트 67번으로 UDP 패킷을 보냄
    * DHCP 제공 : DHCP 발견 메시지를 받은 DHCP 서버는 DHCP 제공 메시지(목적지 IP주소 : 255.255.255.255, 제공 IP주소, IP주소 임대기간 등)로 응답
    * DHCP 요청 : 여러 서버 제공자 중 하나를 선택하여 DHCP 요청 메시지로 응답 
    * DHCP ACK : DHCP ACK 메시지를 통하여 요청을 확인
    ##### (b) 단점
    * 새로운 서브넷에 연결될 때마다 IP를 주소를 새로 얻으므로 이동 시 원격 애플리케이션의 TCP 연결이 유지될 수 없음

<br>

## 2. IPv6

---

### 1) 필요성
 - IPv4 주소 고갈의 위험, 더 많은 주소가 필요
 - IP패킷의 전송 속도 상승

<br>

### 2) 데이터그램 포맷
#### (1) 헤더 : 40바이트로 크기 고정
 - `버전` : IP 프로토콜 버전, IPv6은 6
 - `트래픽 클래스` : IP 데이터그램의 유형을 구별(실시간, 우선순위, 음성 등)
 - `흐름 레이블` : 데이터그램의 특정 트래픽 흐름
 - `페이로드 길이` : 데이터(페이로드) 길이
 - `다음 헤더` : 데이터그램의 데이터가 전달될 프로토콜 구분(TCP, UDP)
 - `홉 제한` : 라우터가 데이터그램을 전달할 때마다 1씩 감소, 홉 제한이 0보다 작아지면 폐기
 - `출발지 IP 주소와 목적지 IP 주소` : 출발지와 목적지의 IP 주소로 128비트를 차지, 여러 호스트 중 가장 가까운 호스트로 패킷을 전송하는 애니캐스트 주소도 도입
#### (2) 데이터(페이로드) : 전송하고자하는 데이터
#### (3) IPv4에서 사라진 필드
 - `단편화/재결합` : 출발지와 목적지에서만 수행하게 함으로 라우터는 기능이 없어져 네트워크에서 IP전달 속도가 증가
 - `헤더 체크섬` : 트랜스포트 계층 프로토콜과 데이터 링크 프로토콜이 기능을 수행하기에 생략하고 네트워크에서 IP전달 속도 증가
 -  `옵션` : 고정 길이 40바이트의 헤더를 갖게 되고 기존의 옵션 필드는 다음 헤더 중 하나가 될 수 있음

<br>

### 3) 터널링 : IPv4에서 IPv6로 전환
```
IPv6의 데이터그램을 IPv4의 데이터로 캡슐화하여 IPv4를 거쳐서 IPv6 시스템으로 전송
```

<br>

## 3. 네트워크 주소 변환(NAT)

---

### 1) 필요성
 - 네트워크의 확산으로 SOHO(small office, home office)의 많은 IP장치에 주소범위를 할당해야 함

<br>

### 2) 방법
 - 홈 네트워크와 같은 네트워크 내에서만 의미를 갖는 사설 네트워크 주소 사용
 - 글로벌 인터넷과의 송수신은 하나의 공인 IP주소를 사용
 - 라우터에서 NAP 변환 테이블을 사용하여 각 IP 주소와 포트번호를 이용하여 두 IP 주소를 연결

<br>

### 3) 반대 의견
 - IP 주소를 변환하는 방식으로 통신하므로 호스트가 직접적으로 연결되는 P2P와 같은 통신에서 문제 발생
 - IP 주소를 수정하는 노드를 간섭하지 않고 포트 수보다 적은 수의 호스트가 서로 직접 소통해야 한다는 원칙 위반
