# 4.4 일반화된 포워딩 및 소프트웨어 기반 네트워크(SDN)

[4.4.1] 매치 </br>
[4.4.2] 액션 </br>
[4.4.3] 매치 플러스 액션 작업의 OpenFlow 예 </br>

</br>
</br>

> 목적지 IP 주소를 찾은('매치')후 패킷을 스위치 구조로 지정된 출럭 포르토 전송('액션') 하는 두단계의 목적지 기반 포워딩을 4.2.1절에서 설명했다.

프로토콜 스택의 다른 계층에서 다른 프로토콜과 관련된 여러 헤더 필드에 대해 `매치`를 수행할 수 있는 일반적인 `매치 플러스 액션` 방법을 생각해보자.

`액션`은 하나 이상의 출력 포트로 패킷을 전달하고, 인터페이스에서 나가는 패킷을 로드 밸런싱(load balancing)하고 헤더값을 다시 쓰고, 의도적으로 패킷을 차단/삭제 및 추가 처리 작업을 위해 특수 서버로 패킷을 보내는 등의 작업을 수행한다.</br>
+) 로드 밸런싱 : 네트워크나 컴퓨팅 시스템에서 발생하는 작업이나 트래픽을 여러 대의 서버나 네트워크 장비로 분산시켜 성능을 최적화하는 기술.

일반화된 <ins>포워딩에서는 각각의 패킷 스위치는 원격 컨트롤러에 의해 계산 및 분포된 `매치 플러스 액션 테이블`을 포함</ins>하고 있다.

<p align="center"><img width="500" alt="일반화된 포워딩" src="https://user-images.githubusercontent.com/76640167/212715327-0ef5af73-4e96-4ee4-bdba-138c23bf6312.png">

위 그림은 `매치 플러스 액션 테이블`을 보여주며, 테이블은 원격 컨트롤러를 통해 계산, 설치, 갱신된다. 

</br>

### 일반화된 포워딩 : OpenFlow 1.0

OpenFlow는 SDN(소프트웨어 정의 네트워킹)의 개념을 도입한 프로토콜 중 하나로, 

네트워크 간의 통신과 제어를 중앙 집중식으로 관리한다.

이를 통해 네트워크 관리자는 네트워크 동작을 프로그래밍적으로 제어할 수 있다.

일반화된 포워딩의 `매치 플러스 액션 테이블`은 목적지 기반 포워딩 테이블의 개념을 일반화한다.

</br>

### Flow Table
> 매치 조건에 따라 패킷이 처리되어야 할 액션(처리내용)을 정의한 플로우 엔트리를 가진 테이블
</br>

OpenFlow의 `매치 플러스 액션 포워딩 테이블`을 부르는 용어

</br>

**플로우의 각 엔트리가 포함하는 특성**
- 들어오는 패킷에 대한 `헤더값`들의 세트가 매치될 것이다.
  - 하드웨어 기반 매치는 TCAM 메모리에서 가장 신속하게 수행
  - 백만 개가 넘는 목적지 주소를 동반
  - 플로우 테이블 엔트리와 매치되지 않는 패킷은 원격 컨트롤러로 전송 가능(처리율 증가) 
- 패킷들에 의해 갱신되는 `카운터 세트`는 플로우 테이블 엔트리들과 매치된다.
  - 카운터는 플로우 테이블 엔트리와 마지막으로 갱신된 테이블 엔트리 이후에 매치된 다수의 패킷을 포함하고 있다.
- 패킷이 플로우 테이블 엔트리와 매치될 때 여러 가지 `액션`이 가능해진다.
  - 패킷을 지정된 출력 포트로 전달
  - 패킷을 삭제
  - 패킷의 복사본을 만들어 여러 출력 포트로 보냄.

</br>
</br>
</br>

## 4.4.1 매치
<p align="center"><img width="700" alt="매치 인 액션 매치" src="https://user-images.githubusercontent.com/76640167/213117975-972cdf56-575f-4e0d-b9b2-662f3ea2278f.png">

위 그림은 OpenFlow 1.0 `매치 플러스 액션` 규칙에서 매치될 수 있는 11개의 패킷 헤더 필드와 수신 포트 ID를 보여준다.

`출발지 및 목적지 MAC 주소 필드` 
- 프레임 송신 및 수신 인터페이스와 연관된 링크 계층 주소.
- IP 주소가 아닌 이더넷 주소를 기반으로 전달함.

`이더넷 타입 필드`
- 상위 계층의 프로토콜, 즉 프레임의 페이로드가 역 다중화되는 프로토콜

`VLAN ID`
- 가상 로컬 영역 네트워크와 연결됨. (6장)

`진입 포트`
- 패킷이 수신되는 패킷 스위치의 입력 포트를 나타냄.
  
`IP 출발지, 목적지`
- 자신의 IP 주소와 목적지 IP 주소를 넣는 곳

`IP 프로토콜`
- IP 데이터그램이 최종 목적지에 도달했을 때 사용, 특정 프로토콜을 명시

`ÌP TOS`
- 각 다른 유형의 IP 데이터 그램을 구벼할 떄 쓰임.
  
</br>
</br>

플로우 테이블 엔트리에는 와일드 카드가 있을 수 있다. (패킷의 특정 부분에 대해 매칭을 유연하게 함.)
- 예를 들어, 플로우 테이블의 `128.119.*.*` 의 주소는 128.119를 주소의 첫 번째 16 비트로 갖는 데이터그램의 해당 주소 필드와 매치된다.

</br>

각 플로우 테이블 엔트리는 관련 우선순위가 있다.
- 패킷이 여러 플로우 테이블 엔트리와 매치되면, 선별된 매치 엔트리에 해당하는 패킷이 가장 높은 우선순위가 된다.

</br>

IP헤더의 모든 필드가 매치될 수 있는 것은 아니다.
- 예를 들어 OpenFlow에서는 TTL 필드 또는 데이터그램 길이 필드에 기반한 매치를 허용하지 않는다.
- 잘 매치되는 필드와 그렇지 않은 필드가 존재하는 이유?
  - 기능과 복잡성 간의 절충을 위해서 (너무 많은 세부사항과 일반성을 가진 추상화에 과도한 부담을 주지않고 작업을 수행하기 위해)
 
</br>
</br>
</br>

## 4.4.2 액션
각 플로우 테이블 엔트리는 플로우 테이블 엔트리와 매치되는 패킷 처리를 결정하는 0개 이상의 `액션 목록`을 가지고 있다. 

여러 액션이 있는 경우 목록에 지정된 순서대로 수행된다.

### 가장 중요한 액션들
`포워딩(Forwarding)`
- 들어오는 패킷은 특정 실제 출력 포트로 전달되거나 모든 포트를 통해 브로드캐스드되거나 선택된 포트 세트를 통해 멀티 캐스트될 수 있다.
  - 브로드캐스트: 메시지를 모든 연결된 장치에 전송하는 것.
  - 멀티 캐스트 : 메시지를 특정 그룹의 장치에 전송하는 것.
- 패킷을 캡슐화되어 원격 컨트롤러로 전송될 수 있다. </br>
  → 그런 다음 컨트롤러는 새 플로우 테이블 엔트리를 설치하고 해당 패킷에 대한 조치를 취하거나 갱신된 플로우 테이블 규칙에 따라 포워딩을 위해 패킷을 장치로 반환할 수 있다.
</br>

`삭제(Dropping)`
- 아무 액션이 없는 플로우 테이블 엔트리는 매치된 패킷을 삭제해야함을 나타낸다.
`필드 수정(Modify-field)
- 패킷이 선택된 출력 포트로 전달되기 전에 10개의 패킷 헤더 필드의 값을 다시 쓸 수 있다.
  
</br>
</br>
</br>

## 4.4.3 매치 플러스 액션 작업의 OpenFlow 예

<p align="center"><img width="500" alt="OpenFlow exam" src="https://user-images.githubusercontent.com/76640167/212724509-ca68b882-f24f-4393-9034-e7fa6bce256d.png">

위 그림의 상황을 가정하고 다음 예시들을 보자.
네트워크에는 6개의 호스트와 3개의 패킷 스위치가 있으며 각각 4애의 로컬 인터페이스가 있다.

<br/>

### 첫 번째 예: 간단한 포워딩

아주 간단한 예로 포워딩 동작이 h3 또는 h4로 예정된 h5 또는 h6 패킷이 s3에서 s1으로 전달된 다음 s1에서 s2로 전달된다고 가정한다.

위 상황에서 s1의 플로우 테이블 엔트리는 다음과 같다.

<p align="center"><img width="500" alt="간단한 포워딩 s1" src="https://user-images.githubusercontent.com/76640167/212725481-048ae901-3c53-4e3c-a86a-d6f6d53fab09.png">


s3에 플로우 테이블 엔트리가 필요하므로 h5 또는 h6에서 전송된 데이터그램은 인터페이스 3을 통해 s1으로 전달된다.

<p align="center"><img width="500" alt="간단한 포워딩 s2" src="https://user-images.githubusercontent.com/76640167/212725550-5273ec3e-4800-44d1-b038-177fd36a96ad.png">

마찬가지로, s1에 도착한 데이터그램을 호스트 h3 또는 h4로 전달할 수 있도록 s2에 플로우 테이블 엔트리가 필요하다.

위를 바탕으로 직접 채워보길 바란다.

<br/>

### 두번째 예: 로드 밸런싱

두 번째 예로 h3에서 `10.1.*.*`로 향하는 데이터그램이 s2와 s1 사이의 링크를 통해 전달되는 반면, h4에서 `10.1.*.*` 로의 데이터그램은 s2와 s3 사이의 링크를 통해 전달되는 로드 밸런싱 시나리오를 고려해보자.

이 동작은 IP의 목적지 기반 포워딩으로 수행될 수 없다.

이 경우 s2의 포워딩 테이블은 다음과 같다.

<p align="center"><img width="500" alt="로드 밸런싱" src="https://user-images.githubusercontent.com/76640167/212727669-ff3f78b5-625c-410c-b873-c0b37ac82a51.png">

s2에서 수신한 데이터그램을 h1 또는 h2로 전달하려면 s1에서 플로우 테이블 엔트리가 필요하다.

인터페이스 4에서 수신한 데이터그램을 s3에서 인터페이스 3을 통해 s1로 전달하려면 s3에서 플로우 테이블 엔트리가 필요하다. s1및 s3에서 이러한 플로우 테이블 엔트리를 파악할 수 있는지 확인하자.

<br/>

### 세번째 예: 방화벽

<p align="center"><img width="500" alt="방화벽" src="https://user-images.githubusercontent.com/76640167/212728865-3eefb52a-15fd-4555-927e-911971ce3725.png">

s2가 s3에 연결된 호스트에서 보낸 트래픽만 수신하려고 하는 방화벽 시나리오를 생각해보자.

s2 플로우 테이블에 다른 엔트리가 없으면 `10.3.*.*`의 트래픽만 s2에 연결된 호스트로 전달된다.

<br/>

<br/>

`매치 플러스 액션` 플로우 테이블은 제한된 형태의 **프로그래밍 가능성**이다.

데이터그램의 헤더값과 매치 조건 사이의 매치를 기반으로 라우터가 데이터그램을 전달하고 조작하는 방법을 명시한다.

**따라서 더 풍부한 형태의 프로그래밍 가능성을 상상할 수 있다.**
