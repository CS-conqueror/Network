# TCP 연결의 보안(트랜스포트 계층) : TLS

<br>

## TLS
 > 보안 서비스로 강화된 TCP 서비스를 제공하는 트랜스포트 프로토콜

<br>

## almost-TLS : 단순화된 TLS

---

### 핸드셰이크

<p align="center"><img width="500" src="https://user-images.githubusercontent.com/76640167/217584333-c8cd0c65-1518-4207-82d2-bef569cd6208.png" alt="handshake"></p>

 - 단계
  1. 수신자는 송신자와 TCP 연결을 설립
  2. 수신자가 진짜 맞는지 확인
  3. TLS 세션에 필요한 모든 대칭키를 생성하기 위해 사용할 주 비밀키(MS)를 송신자가 생성 후 암호화 하여 수신자에 전달
  4. 수신자가 자신의 개인키를 가지고 복호화함으로 주 비밀키를 얻음

### 키유도
> 수신자와 송신자는 MS를 이용하여 4개의 키를 생성

 - 송신자가 수신자에게 보내는 데이터에 대한 세션 암호화 키
 - 수신자가 송신자에게 보내는 데이터에 대한 세션 암호화 키
 - 송신자가 수신자에게 보내는 데이터에 대한 세션 HMAC 키
 - 수신자가 송신자에게 보내는 데이터에 대한 세션 HMAC 키

###  데이터 전송
 - TLS는 데이터 스트림을 레코드로 쪼개고 각 레코드에 무결성 검사를 위한 HMAC을 붙여서 암호화하여 인터넷 상으로 전송하기 위해 TCP로 보냄
 - 침입자가 TCP 세그먼트 스트림을 삽입, 삭제, 교환하는 경우를 예방하기 위해 순서 번호를 사용
 - HMAC은 데이터와 HMAC 키, 순서 번호를 합친 결과의 해시값

### TLS 레코드

<p align="center"><img width="500" src="https://user-images.githubusercontent.com/76640167/217584324-5d6e5c1a-4765-4807-bfb9-54fab7f71106.png" alt="레코드의 포맷"></p>

- 레코드는 타입, 버전, 길이, 데이터, HMAC 필드로 이루어져 있음(암호화는 데이터와 HMAC만 실시)

<br>

## 완전한 TLS

---

### TLS 핸드셰이크
 1. 클라이언트는 넌스와 함께 자신이 지원하는 암호화 알고리즘 목록 전송
 2. 목록으로부터 서버는 대칭키 알고리즘, 공개키 알고리즘, HMAC 키와 HMAC 알고리즘을 선택, 서버는 선택 결과와 인증서, 서버 넌스를 클라이언트에 전송(넌스는 연결 재생 공격에 대응)
 3. 클라이언트는 인증서를 확인하고 서버의 공개키를 알아낸 후 PMS(Pre-Master Secret)를 생성하고 PMS를 서버의 공개키로 암호화한 후 서버에 전송
 4. 클라이언트와 서버는 같은 키 유도 함수를 사용하여 PMS와 넌스로부터 독립적으로 MS를 계산한 후 MS는 2개의 암호화 키와 2개의 HMAC 키를 생성하기 위해 분할
    , 선택된 대칭 암호화가 CBC 이용 시 연결의 양측을 위해 하나씩 2개의 IV(Initialization Vector)를 MS로부터 얻고 이후부터 클라이언트와 서버는 모든 메시지를 암호화하고 인증
 5. 클라이언트는 모든 핸드셰이크 메시지의 HMAC을 전송(약한 알고리즘을 선택하게 하는 훼손 공격 예방)
 6. 서버는 모든 핸드셰이크 메시지의 HMAC을 전송

### 연결 종료
 - TCP FIN 세그먼트를 보내 TCP 연결을 끊고 TLS 세션을 종료하게 하면 절단 공격에 취약하므로 레코드의 타입 필드에 TLS 세션 종료를 수행할 것인지 표시
   
