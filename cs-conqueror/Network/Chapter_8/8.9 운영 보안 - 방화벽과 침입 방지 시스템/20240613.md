# 8.9 운영 보안 : 방화벽과 침입 탐지 시스템

컴퓨터 네트워크에서는 네트워크를 드나드는 트래픽의 보안 검사, 로그 기록, 또는 버려지거나 전달되는 작업이 방화벽, 침입 감지 시스템(IDS), 침입 방지 시스템(IPS)으로 알려진 운영 장치에서 수행됨

## 8.9.1 방화벽

<p align="center"><img width="500" src="https://user-images.githubusercontent.com/76640167/218083755-bbfd6ae9-2b06-443f-b9b6-4ca04c7225a6.png" alt="방화벽"></p>


**방화벽** : 전체 인터넷으로부터 기관의 내부 네트워크를 분리시킨 하드웨어와 소프트웨어의 조합
- 어떤 패킷은 통과가 허용되나, 어떤 패킷은 차단
- 네트워크 관리자가 해당 네트워크에 대한 트래픽 출입을 관리함으로써 외부 세계와 관리 네트워크 내 자원 간의 접속을 제어할 수 있게 함
- 방화벽의 세 가지 목표
    - 외부와 내부를 오가는 모든 트래픽은 방화벽을 거침
        - 하나의 방화벽을 네트워크의 유일한 AP에 두는 것이 보안 접근 정책 관리 강화에 용이
    - 로컬 보안 정책에 정의된 대로 승인된 트래픽만이 통과가 허용
        - 기관의 네트워크에 드나드는 모든 트래픽이 방화벽을 통과하게 함으로써 외부의 접속을 승인된 트래픽만으로 제한할 수 있음
    - 방화벽 자체가 침입 시도에 안전해야 함
        - 방화벽 자체가 네트워크에 연결된 장치
        - 올바르게 설계되거나 설치되지 않으면 잘못된 의미의 보안을 제공하게 됨

- 방화벽은 **전통적인 패킷 필터(tarditional packet filter), 상황 고려 필터(stateful filter), 애플리케이션 게이트웨이(application gateway)** 이렇게 세 가지로 분류

### 전통적인 패킷 필터

 하나의 기관은 일반적으로 내부의 네트워크를 ISP에 연결하는 게이트웨이 라우터를 가짐
 <br/>
 내부 네트워에 대한 모든 입출력 트래픽은 이 라우터를 통과해야 하고, 패킷 필터링이 발생
 <br/>
 패킷 필터는 각 데이터그램을 독립적으로 검사하면서 규칙에 따라 통과시킬지 버릴지 결정
 
 - 일반적인 필터링 근거
    - IP 출발지 또는 목적지 주소
    - IP 데이터그램 내의 프로토콜 타입 : TCP, UDP, ICMP, OSPF 등
    - TCP 또는 UDP 출발지와 목적지 포트
    - TCP 플래그 비트 : SYN, ACK 등
    - ICMP 메세지 타입
    - 네트워크에서 나가는 데이터그램과 들어오는 데이터그램에 대한 서로 다른 규칙들
    - 서로 다른 라우터 인터페이스에 대한 서로 다른 규칙들
- 필터링 정책은 주소와 포트 번호의 조합에 기초
    - 외부 주소에 기초한 정책은 출발지 주소를 위장(spoofing)한 데이터그램을 막을 수 없음
- 필터링은 TCP ACK 비트가 설정되어 있는지 여부에 기초
    - 내부의 클라이언트가 외부 서버에 연결하는 것은 가능하지만, 외부 클라이언트가 내부 서버에 연결하는 것은 막고 싶을 때 유용
    - 첫 번째 세그먼트의 ACK 비트 빼고 모두 다 1 -> ACK 비트가 0인 입력 세그먼트를 걸러내면 됨
    - 외부에서 오는 모든 TCP 연결은 허용하지 않지만 내부에서 나가는 건 가능
- 방화벽의 규칙은 접속 제어 목록과 함께 라우터에 구현
    - 라우터 인터페이스는 각각 자신만의 목록을 가짐
    - 이 목록은 라우터를 기관의 외부 ISP와 연결하는 인터페이스를 위한 것
    - 규칙들은 인터페이스를 통과하는 모든 데이터그램에 적용
    - 처음 두 규칙은 내부 사용자의 웹 서핑을 가능하게 함
        - 첫 번째 규칙은 목적지 포트 번호가 80인 모든 TCP 패킷이 기관 네트워크에서 나갈 수 있게 함
        - 두 번째 규칙은 출발지 포트 번호가 80이고 ACK 비트가 1인 패킷이 들어오는 것을 허용
        - 즉, 기관 내부에서 시작된 웹 트래픽과 DNS 트래픽을 제외한 모든 트래픽을 막음

### 상황 고려 패킷 필터

전통적인 패킷 필터에서는 패킷 차단 결정이 각 패킷에 대해 따로따로 이루어짐
<br/>
반면, 상황 고려 필터는 TCP 연결을 추적하여 이 정보를 패킷 차단 결정을 하는 데 이용
<br/>
ACK = 1, 출발지 포트 80을 가진 모든 패킷을 내부로 들어오는 것을 허용한다면, 조작된 패킷으로 인해 공격을 당할 수 있음
<br/>
TCP ACK 패킷을 막아버리는 방법도 있지만, 그렇다면 기관 내부 사용자도 웹 서핑을 할 수 없음


<BR/>
상황 고려 필터는 이러한 문제를 연결 테이블에 있는 진행 중인 모든 TCP 연결을 추적함으로써 해결

- 방화벽이 세 방향 핸드셰이크를 관찰함으로써 연결의 시작을 알 수 있고, 연결에 대해 FIN을 발견함으로써 연결의 종류를 알 수 있기 때문에 가능
- 상황 고려 필터는 접속 제어 목록에  `연결 검사`라는 새로운 열을 포함
- 연결 테이블을 검사했을 때 패킷이 진행 중인 TCP 연결 어느 것에도 속해 있지 않으면 버려짐

### 애플리케이션 게이트웨이

어떤 기관이 제한된 범위의 일부 내부 사용자들에게만 텔넷 서비스를 제공하고자 할 때
- 세밀한 수준의 보안을 위해 방화벽은 패킷 필터를 애플리케이션 게이트웨이와 결합해야 함
    - 애플리케이션 게이트웨이는 IP/TCP/UDP 헤더 이상의 것을 살펴보고 애플리케이션 데이터에 기초한 정책 결정을 함
    - **애플리케이션 게이트웨이** : 모든 애플리케이션 데이터가 반드시 통과해야 하는 애플리케이션 맞춤 서버
    - 다수의 애플리케이션 게이트웨이가 같은 호스트에서 실행될 수는 있지만, 각 게이트웨이는 자신ㄴ만의 프로세스들을 가진 분리된 서버

<p align="center"><img width="450" src="https://user-images.githubusercontent.com/76640167/218083750-2fd7ea3d-31ca-4a3a-817f-3ec8612fac1a.png" alt="게이트웨이"></p>

- 제한된 내부 사용자만 외부로의 텔넷이 가능하게 하고 모든 외부 클라이언트의 내부 접근을 막는 방화벽 설계
    - 패킷 필터링과 텔넷 애플리케이션 게이트웨이를 결합하여 구현 가능
    - 애플리케이션 게이트웨이의 IP 주소로부터 시작된 텔넷 연결을 제외하고 모든 텔넷 연결 시도를 막도록 라우터의 필터 설정
        - 외부로의 모든 텔넷 연결이 애플리케이션 게이트웨이를 통과하게 만듦
    - 내부에서 외부로 텔넷을 연결할 때, 애플리케이션 게이트웨이와 텔넷 세션을 설정하고, ID와 비밀번호를 입력
        - 애플리케이션 게이트웨이는 그 사용자가 외부 텔넷 연결이 허용되어있는지 검사
- 단점
    - 각 애플리케이션마다 서로 다른 애플리케이션 게이트웨이를 필요로 함
    - 모든 데이터가 게이트웨이를 경유하여 중계되므로 성능상의 손실이 존재
    - 클라이언트 소프트웨어는 사용자가 요구할 때 어떻게 게이트웨이와 통신할 수 있는지 알아야하고, 어떤 외부 서버에 연결할지 애플리케이션 게이트웨이에 알려줄 수 있어야 함

### 8.9.2 침입 탐지 시스템

패킷을 방화벽으로 통과시킬 지 결정할 때 **IP, TCP, UDP, ICMP** 헤더 필드 탐색
<br/>
**자세한 패킷 관찰(deep packet inspection)** : 다양한 공격을 탐지하기 위해서 헤더 필드 내용 외에도 패킷이 갖고 있는 실제 애플리케이션 데이터의 내용까지 살펴보는 것
 - 패킷들의 의심스러움을 발견했을 때 기관 네트워크로 막을 수 있음
 - 통과시키되 네트워크 관리자에게 알려 트래픽을 자세히 관찰하게 하고, 조치를 취하게 할 수 있음
    - **침입 탐지 시스템(instruction detection system, IDS)** : 악의적인 트래픽 발견했을 때 경고를 발생시키는 장치
    - **침입 방지 시스템(instruction prevention system, IPS)** : 의심스러운 트래픽을 걸러내는 장치
    - 둘을 합쳐 IDS 시스템으로 호칭

<p align="center"><img width="500" src="https://user-images.githubusercontent.com/76640167/218083738-b32b455d-c9c3-421c-9e8b-be449923b355.png" alt=IDS""></p>

- IDS(instruction detection system)
    - 네트워크 구성 정보 수집, 포트 정보 수집, TCP 스택 정보 수집, DoS 대역폭 플러딩 공격, 웜과 바이러스, OS 취약점 공격, 애플리케이션 취약점 공격 등 넓은 범위 공격 탐지
    - 하나의 기관에서 내부 네트워크에 2개 이상의 IDS 센서를 설치할 수도 있음
        - 여러 개의 센서가 설치되면 일반적으로 함께 협조하며 일함
        - 의심스러운 정보가 중앙 IDS 프로세서에 전다러
        - 네트워크 패킷 필터, 애플리케이션 게이트웨이, IDS 센서에 의해 감시되는 높은 보안 구역
        - 패킷 필터와 IDS 센서만 사용하는 낮은 보안 구역(DMZ(demilitarized zone))의 두 구역으로 나눔
            - DMZ는 공공의 웹 서버, 공인된 DNS 서버 같은 외부와 통신할 필요가 있는 서버 포함
    - IDS를 여러 개 두는 이유
        - IDS가 자세한 패킷 관찰 + 각각의 패킷을 수만 개의 `시그니처`와 비교해야 하기 때문
        - 엄청난 양의 연산이 필요하기 때문에 IDS 센서들을 안쪽에 위시치심으로써 전체 트래픽의 일부만 관찰하게 만듦
    - 넓게 두 가지로 분류할 수 있음
        - **시그니처 기반 시스템(signature-based system)**
            - 공격 시그니처에 대해 방대한 데이터베이스를 유지
            - 시그니처는 단일 패킷에 대한 특징의 목록, 연속된 일련의 패킷들에 관련한 것 등등임
            - 지나가는 모든 패킷을 읽어 데이터베이스의 시그니처들과 비교
            - 어떤 패킷이 시그니처와 일치한다면 경고를 발생시킴
            - 제약사항
                - 공격에 대한 과거의 지식이 필요함
                - 시그니처가 일치한다 하더라도 공격이 아닐 수 있음 -> 이때 문제 발생
                - 막대한 연산을 다 처리하지 못해 실제로 많은 악의적 패킷을 감지하지 못할 수 있음
        - **이상 기반 시스템(anomally-based system)**
            - 평소 트래픽 분석표를 제작
            - 통계학적으로 비정상적인 패킷의 스트림을 찾음
            - 현존하는 공격에 대한 과거의 지식에 의존하지 않아 새로운 공격도 감지 가능
            - 제약사항
                - 일반적인 트래픽과 통계학적으로 이상한 트래픽을 구별하는 것은 상당히 어려움

### 스노트

공공 도메인의 오픈 소스
<br/>
시그니처 데이터베이스를 유지하고 있는 사용자와 보안 전문가의 거대한 커뮤니티 존재
- 새로운 공격이 나타난 지 몇 시간 안에 이 커뮤니티는 공격 시그니처 작성, 배포
- 스노트 시그니처 구문을 이용하여 네트워크 관리자들은 존재하는 시그니처를 수정하거나 새로운 것을 만들어 해당 기관의 필요에 맞는 시그니처 생성 가능