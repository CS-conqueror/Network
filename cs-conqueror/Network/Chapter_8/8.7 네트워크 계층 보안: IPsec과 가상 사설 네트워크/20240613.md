# 네트워크 계층 보안: IPsec와 가상 사설 네트워크

<br>

## IPsec과 가상 사설 네트워크

---

### IPsec
 - 호스트나 라우터 같은 네트워크 계층의 어떤 두 개체 사이에서 IP 데이터그램을 페이로드 부분을 암호화하여 보호
 - 출발지 인증, 데이터 무결성, 재생 공격 방지 보안 서비스 제공

### 사설 네트워크

 > 호스트와 서버가 안전하게 데이터를 전송할 수 있기 위해 사용하는 공공 인터넷과 완전히 분리된 독립 네트워크

<p align="center"><img width="500" src="https://user-images.githubusercontent.com/76640167/217747985-e18a7a43-82de-41fe-831c-cb5fee6a16d1.png" alt="VPN"></p>

 - 오늘날에는 큰 유지 비용이 드는 사설 네트워크 대신 VPN 설치
 - VPN 사용 시 공공 인터넷을 통해 트래픽이 전송되지만 인터넷에 들어가기 전에 암호화
 - 공공 인터넷을 통과하지 않을 때는 IPv4 데이터그램이 사용되고 공공 인터넷을 통과할 때는 IPsec 데이터그램(IPv4 헤더를 가진)으로 바꾼 후 인터넷에 전송

<br>

## AH와 ESP 프로토콜
> 출발지 IPsec 개체가 보안 데이터그램을 목적지 개체에 보낼 때 사용하는 프로토콜

- `AH프로토콜` : 출발지 인증과 무결성을 제공하지만 기밀성은 제공 안함
- `ESP프로토콜` : 출발지 인증과 데이터 무결성, 기밀성을 제공

<br>

## SA
> 네트워크 계층에서 IPsec 데이터그램 전송 전 출발지 개체와 목적지 개체의 논리적 연결

<p align="center"><img width="500" src="https://user-images.githubusercontent.com/76640167/217747947-c3029c7f-3030-4b01-87e5-5cafe95c7f89.png" alt="SA"></p>

 - SA는 단방향이므로 서로에게 데이터를 보내기 위해 두 개의 SA가 필요
 - SA에 대해 라우터는 다음과 같은 정보 포함
   * SA에 대한 32비트 식별자 SPI
   * SA 시작점의 인터페이스와 최종점의 인터페이스
   * 사용되는 암호화 타입
   * 암호화 키
   * 무결성 검사 타입
   * 인증
 - SA에 대한 상태 정보를 그 개체의 OS 커널에 있는 SAD(security association Database) 데이터 구조에 저장

## IPsec 데이터그램

<p align="center"><img width="500" src="https://user-images.githubusercontent.com/76640167/217747947-c3029c7f-3030-4b01-87e5-5cafe95c7f89.png" alt="SA"></p>

* 송신 라우터
 1. 원래 IPv4 데이터그램의 뒤에 ESP 트레일러를 붙임
 2. SA에 의해 지정된 알고리즘과 키를 이용하여 위 결과를 암호화
 3. 암호화된 결과의 앞에 ESP 헤더 필드를 덧붙임(엔칠라다)
 4. SA가 지정한 알고리즘과 키를 이용하여 전체 엔칠라다에 대한 인증 MAC을 생성
 5. 엔칠라다 뒤에 MAC을 붙여 페이로드를 만든다.
 6. 전형적인 IPv4 헤더 필드를 가지고 완전히 새로운 IP 헤더를 만들어 위의 페이로드 앞에 붙임

* 수신 라우터
 1. IP 헤더를 보고 IPsec ESP 프로토콜을 적용
 2. 엔칠라다를 들여다보고 SPI를 이용하여 데이터그램이 어느 SA에 속한것인지 파악
 3. 엔칠라다의 MAC을 계산하여 ESP MAC 필드의 값과 일치하는지 확인
 4. 데이터그램이 재생된 것이 아닌지 순서 번호 필드를 검사
 5. SA와 관련된 복호화 알고리즘과 키를 이용하여 암호화된 부분을 복호화
 6. 원래의 IP 데이터그램을 최종 목적지로 전송하기 위해 지점 네트워크로 전달

- IPsec 데이터그램은 전형적인 IPv4 헤더를 가지고 페이로드가 따라오는 진짜 IPv4 데이터그램
- 전달하는 라우터들은 IPsec으로 암호화된 정보라는 것을 모른체 목적지 라우터 인터페이스로 이를 전달
- Psec 개체는 SAD와 함께 SPD(security policy database)라 불리는 자료구조를 유지
- SPD의 정보는 도착한 데이터그램으로 무엇을 할지 알려주고, SAD의 정보는 어떻게 할 것인지를 알려줌

<br>

## IKE: IPsec에서의 키 관리

---

> 수많은 IPsec 라우터와 호스트로 이루어진 VPN에서는 종단점의 SAD에 의해 직접 SA 정보를 입력 하는 방법은 불가하므로 SA를 자동으로 생성하는 IKE 프로토콜을 이용

- IPsec 개체는 그 개체의 공개키가 포함된 인증서 보유
- IKE 프로토콜은 두 개체가 인증서를 교환하고 인증과 암호화 알고리즘에 대한 협상을 하게 하며 IPsec SA의 세션키를 생성하기 위한 중요한 자료를 안전하게 교환

### 첫번째 단계 : 메시지 쌍을 두 번 교환한다
- 첫번째 메시지 교환 : 양측이 라우터 사이의 IKE SA를 설립하기 위해 디피-헬만 알고리즘을 사용
   * IKE SA는 IPsec SA와 다름
   * IKE SA는 두 라우터 사이에 인증되고 암호화 된 채널 제공
   * 첫 번째 메시지를 교환하는 동안 IKE SA의 암호화와 인증을 위한 키가 설립
   * 두번째 단계에서 IPsec SA 키를 계산하기 위해 사용될 주 비밀키도 생성
   * 첫번째에서는 누구도 비밀키로 서명함으로써 자신의 신분을 드러내지 않음
- 두번째 메시지 교환 : 양측이 메시지에 서명하여 신분을 드러냄
   * 메시지가 보안 처리된 IKE SA 채널을 통해 전송되므로 단순한 도청자에게는 신분이 누설되지 않음
   * 양측이 IPsec SA에 의해 사용될 IPsec 암호화 및 인증 알고리즘에 대해 협의

### 두번째 단계 : 양측이 각 방향으로 하나씩 SA를 설립
 - 2개의 SA에 대한 암호화 및 인증 세션키가 양측에 생성
 - 보안 처리된 데이터그램을 만들기 위해 SA 사용
